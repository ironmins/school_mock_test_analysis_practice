<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고등학교 모의고사 성적 분석 프로그램</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- 눈 내리는 효과 -->
    <div class="snowflakes" aria-hidden="true">
        <div class="snowflake">❄</div>
        <div class="snowflake">❅</div>
        <div class="snowflake">❆</div>
        <div class="snowflake">❄</div>
        <div class="snowflake">❅</div>
        <div class="snowflake">❆</div>
        <div class="snowflake">❄</div>
        <div class="snowflake">❅</div>
        <div class="snowflake">❆</div>
        <div class="snowflake">❄</div>
    </div>

    <div class="container">
        <header>
            <h1>고등학교 모의고사 성적 분석 프로그램 <span class="badge-lite">Web</span></h1>
        </header>

        <div class="upload-section">
            <div class="upload-guide">
                <p><strong>📋 모의고사 성적 엑셀 파일 업로드 방법:</strong></p>
                <p>엑셀 파일은 <strong>DATA</strong> 시트에 다음 형식으로 작성되어야 합니다:</p>
                <ul class="format-list">
                    <li><strong>1행:</strong> 영역명 (학년, 반, 번호, 이름, 국어영역, 수학영역, 영어영역, 탐구1과목, 탐구2과목, 탐구3과목, 제2외국어, 총계)</li>
                    <li><strong>2행:</strong> 세부항목 (과목, 원점수, 표준점수, 백분위, 등급)</li>
                    <li><strong>3행 이후:</strong> 학생 성적 데이터</li>
                </ul>
                <p class="warning-text"><strong>⚠️ 주의: <span class="xlsdata">XLSX</span> 또는 <span class="xlsdata">XLSM</span> 파일만 업로드 가능합니다.</strong></p>
                <div class="privacy-notice">
                    <p>🔒 보안 안내</p>
                    <ul>
                        <li>업로드한 성적 파일은 <strong>서버에 전송/저장되지 않습니다</strong>.</li>
                        <li>모든 분석은 <strong>사용자의 브라우저(로컬)</strong>에서만 수행됩니다.</li>
                        <li>페이지를 닫거나 새로고침하면 메모리에 남은 데이터는 사라집니다.</li>
                    </ul>
                    <p class="privacy-footnote">즉, 업로드한 양식은 외부로 유출되지 않습니다 🙂</p>
                </div>
            </div>
            <div class="section-divider"></div>
            <div class="file-input-wrapper">
                <input type="file" id="excelFiles" accept=".xlsx,.xlsm" multiple />
                <label for="excelFiles" class="file-input-label">
                    <span>엑셀 파일 업로드 (여러 파일 가능)</span>
                </label>
                <div class="upload-hint">클릭 또는 드래그로 업로드</div>
            </div>
            <div id="fileList" class="file-list" style="display: none;"></div>
            <div class="action-buttons">
                <button id="analyzeBtn" class="analyze-btn" disabled>분석 시작</button>
                <button id="exportCsvBtn" class="analyze-btn" disabled style="margin-left: 10px;">통합 데이터 내보내기</button>
                <button id="exportHtmlBtn" class="analyze-btn" disabled style="margin-left: 10px;">분석결과 HTML 저장</button>
            </div>
        </div>

        <div id="results" class="results-section" style="display: none;">
            <div class="tabs">
                <button class="tab-btn active" data-tab="overview">전체 통계</button>
                <button class="tab-btn" data-tab="subjects">과목별 분석</button>
                <button class="tab-btn" data-tab="class">학급별 분석</button>
                <button class="tab-btn" data-tab="students">학생별 분석</button>
            </div>

            <!-- 전체 통계 탭 -->
            <div id="overview-tab" class="tab-content active">
                <h2>전체 통계</h2>
                <div class="overview-stats">
                    <div class="stat-card">
                        <div class="stat-label">전체 학생 수</div>
                        <div id="totalStudents" class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">평균 백분위</div>
                        <div id="avgPercentile" class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">평균 표준점수</div>
                        <div id="avgStandard" class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">평균 원점수</div>
                        <div id="avgRaw" class="stat-value">-</div>
                    </div>
                </div>

                <div class="chart-section">
                    <h3>학급별 백분위 분포</h3>
                    <canvas id="classPercentileChart"></canvas>
                </div>

                <div class="chart-section">
                    <h3>영역별 평균 등급</h3>
                    <canvas id="subjectGradeChart"></canvas>
                </div>
            </div>

            <!-- 과목별 분석 탭 -->
            <div id="subjects-tab" class="tab-content">
                <h2>과목별 분석</h2>
                <div id="subjectAverages" class="subject-averages"></div>
                
                <div class="chart-section">
                    <h3>과목별 평균 점수 비교</h3>
                    <canvas id="subjectCompareChart"></canvas>
                </div>
            </div>

            <!-- 학급별 분석 탭 -->
            <div id="class-tab" class="tab-content">
                <h2>학급별 분석</h2>
                <div id="classAnalysis" class="class-analysis"></div>
                
                <div class="chart-section">
                    <h3>학급별 평균 비교</h3>
                    <canvas id="classCompareChart"></canvas>
                </div>
            </div>

            <!-- 학생별 분석 탭 -->
            <div id="students-tab" class="tab-content">
                <h2>학생별 분석</h2>
                <div id="studentAnalysis" class="student-analysis">
                    <div class="student-selector">
                        <div class="selector-group">
                            <label for="gradeSelect">학년:</label>
                            <select id="gradeSelect" class="selector">
                                <option value="">전체</option>
                            </select>
                        </div>
                        <div class="selector-group">
                            <label for="classSelect">반:</label>
                            <select id="classSelect" class="selector">
                                <option value="">전체</option>
                            </select>
                        </div>
                        <div class="selector-group">
                            <label for="studentSelect">번호:</label>
                            <select id="studentSelect" class="selector">
                                <option value="">학생 선택</option>
                            </select>
                        </div>
                        <div class="selector-group">
                            <label for="studentNameSearch">이름:</label>
                            <input id="studentNameSearch" class="selector" type="text" placeholder="이름으로 검색" />
                        </div>
                        <button id="showStudentDetail" class="detail-btn" disabled>상세 분석</button>
                        <button id="pdfClassBtn" class="detail-btn" title="선택한 학급 전체 PDF 저장">학급 전체 PDF</button>
                    </div>
                    
                    <div class="view-toggle">
                        <button id="tableViewBtn" class="toggle-btn active">전체 테이블</button>
                        <button id="detailViewBtn" class="toggle-btn">개인 상세</button>
                    </div>
                    
                    <div id="tableView" class="table-view">
                        <div class="search-box">
                            <input type="text" id="studentSearch" placeholder="학생 번호 또는 이름으로 검색...">
                        </div>
                        <div id="studentTable" class="student-table"></div>
                    </div>
                    
                    <div id="detailView" class="detail-view" style="display: none;">
                        <div id="studentDetailContent" class="student-detail-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>분석 중...</p>
        </div>

        <div id="error" class="error-message" style="display: none;"></div>

        <footer class="app-footer">
            <div class="footer-right">
                <div class="credits">Based on 전주고등학교 모의고사 성적 분석 시스템</div>
                <span class="updated" id="lastUpdated"></span>
            </div>
        </footer>
    </div>

    <script src="script.js"></script>
    <script>
        (function updateLastUpdated() {
            try {
                const el = document.getElementById('lastUpdated');
                if (!el) return;
                const pad = (n) => String(n).padStart(2, '0');
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                const kstDate = new Date(utc + 9 * 3600000);
                const y = kstDate.getFullYear();
                const m = pad(kstDate.getMonth() + 1);
                const d = pad(kstDate.getDate());
                const hh = pad(kstDate.getHours());
                const mm = pad(kstDate.getMinutes());
                el.textContent = `Last updated: ${y}-${m}-${d} ${hh}:${mm} (KST)`;
            } catch (e) {
                // no-op
            }
        })();
    </script>
</body>
</html>
